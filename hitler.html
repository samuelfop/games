<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - Web Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Germania+One&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --liberal: #65aadd; 
            --fascist: #d64d4d;
            --bg: #222;
            --text: #eee;
            --gold: #d4af37;
        }
        
        body { 
            font-family: 'Roboto Mono', monospace; 
            background: var(--bg); color: var(--text); 
            text-align: center; margin: 0; padding: 20px; 
            padding-bottom: 60px; /* Space for credits */
        }
        
        h1, h2, h3 { font-family: 'Germania One', cursive; letter-spacing: 1px; margin: 10px 0; }
        .hidden { display: none !important; }
        
        /* CARD STYLES */
        .card-ui {
            background: #f4e4bc; color: #333;
            padding: 15px; margin: 10px auto;
            border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            max-width: 500px;
        }

        /* POLICY TRACKS */
        .track-container { margin: 20px 0; }
        .track-title { margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        
        .policy-slot { 
            width: 60px; height: 90px; 
            border: 3px dashed #555; display: inline-block; margin: 4px; 
            position: relative; vertical-align: top;
            background: rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .policy-slot.filled-lib { background: var(--liberal); border: 3px solid #fff; box-shadow: 0 0 10px var(--liberal); }
        .policy-slot.filled-fas { background: var(--fascist); border: 3px solid #fff; box-shadow: 0 0 10px var(--fascist); }
        
        .power-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.6em; line-height: 1em; color: rgba(255,255,255,0.4);
            font-family: sans-serif; text-transform: uppercase; width: 100%;
        }

        /* BUTTONS */
        .btn { 
            padding: 12px 24px; font-size: 1em; 
            font-family: 'Germania One', cursive; cursor: pointer; 
            background: #444; color: white; border: 1px solid #666; 
            margin: 5px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-ja { background: #f4e4bc; color: var(--fascist); border: 3px solid var(--fascist); font-size: 1.2em; }
        .btn-nein { background: #f4e4bc; color: #333; border: 3px solid #333; font-size: 1.2em; }
        .btn-action { background: var(--gold); color: #000; border: 2px solid #8a7018; }
        
        /* ROLES */
        .secret-role { 
            padding: 15px; border: 8px solid; display: none; 
            margin: 10px auto; max-width: 300px; 
            background: #f4e4bc; color: #222;
        }
        .role-liberal { border-color: var(--liberal); }
        .role-fascist { border-color: var(--fascist); }
        
        /* FOOTER CREDITS */
        footer {
            margin-top: 50px; font-size: 0.7em; color: #777; 
            border-top: 1px solid #444; padding-top: 20px;
        }
        footer a { color: #999; text-decoration: none; }
    </style>
</head>
<body>

    <div id="notification-area" style="position:fixed; top:0; left:0; width:100%; background:gold; color:black; padding:10px; font-weight:bold; display:none; z-index:999;"></div>

    <div id="setup-screen">
        <h1 style="font-size: 3em; color: var(--fascist); text-shadow: 2px 2px #000;">SECRET HITLER</h1>
        <div class="card-ui">
            <h3>IDENTIFICATION</h3>
            <input type="text" id="playerName" placeholder="Enter Name" style="padding:10px; font-size:1.1em;">
            <br><br>
            <button class="btn" onclick="createGame()">Create Game (Host)</button>
            <button class="btn" onclick="joinGame()">Join Game (Player)</button>
        </div>
    </div>

    <div id="host-view" class="hidden">
        <div style="border-bottom: 2px solid #444; padding-bottom: 10px; margin-bottom: 20px;">
            <h2 style="color:var(--gold);">GAME CODE: <span id="display-game-code" style="color:#fff;"></span></h2>
            <div id="game-status" style="color: #aaa;">Status: Waiting...</div>
        </div>

        <div id="lobby-list" style="color: #888; margin-bottom:20px;"></div>
        <button id="start-btn" class="btn hidden" onclick="startGame()" style="background:var(--fascist); font-size:1.4em;">START GAME</button>
        
        <div id="game-board" class="hidden">
            <div class="track-container">
                <div class="track-title" style="color:var(--liberal)">Liberal Acts</div>
                <div id="lib-track"></div>
            </div>
            <div class="track-container">
                <div class="track-title" style="color:var(--fascist)">Fascist Acts</div>
                <div id="fas-track"></div>
            </div>
            
            <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
                <div class="card-ui" style="width:150px; margin:0;">
                    <strong>ELECTION</strong><br>
                    <span id="tracker-count" style="font-size:2em; color:red;">0</span> / 3
                </div>
                <div class="card-ui" style="width:150px; margin:0;">
                    <strong>DECK</strong><br>
                    <span id="deck-count" style="font-size:2em;">--</span>
                </div>
            </div>
            <div id="gov-display" style="margin-top:20px; font-size:1.2em; color:var(--gold);"></div>
        </div>
    </div>

    <div id="player-view" class="hidden">
        <h2 id="my-name-display" style="text-transform:uppercase; color:var(--gold);">PLAYER</h2>
        <button class="btn" onclick="toggleRole()">Show/Hide Role</button>
        
        <div id="my-role-card" class="secret-role">
            <div style="font-size:0.8em; text-transform:uppercase; border-bottom:1px solid #000;">Party Membership</div>
            <h1 id="role-text" style="font-size:2.5em; margin:10px 0;">ROLE</h1>
            <p id="role-desc" style="font-style:italic; font-size:0.9em;"></p>
            <hr style="border:1px dashed #444;">
            <p id="team-info" style="font-weight:bold; font-size:0.9em;"></p>
        </div>

        <div id="player-action-area" style="margin-top:30px;">
            <div id="wait-msg" style="color:#888; font-style:italic;">Waiting for government...</div>
            <div id="active-controls" class="card-ui hidden">
                <h3 id="control-title" style="margin-top:0; border-bottom:1px solid #ccc;">ACTION</h3>
                <p id="control-desc"></p>
                <div id="control-btns" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>
            [cite_start]<strong>SECRET HITLER</strong> created by Mike Boxleiter, Tommy Maranges, Max Temkin, and Mac Schubert. [cite: 411]<br>
            [cite_start]Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons BY-NC-SA 4.0</a>. [cite: 412]<br>
            This web adaptation is not affiliated with the creators.
        </p>
    </footer>

<script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcn5aaeBbPfWRNm_xremdSHFuI6S4_VCs",
            authDomain: "seceret-4c9b8.firebaseapp.com",
            databaseURL: "https://seceret-4c9b8-default-rtdb.firebaseio.com",
            projectId: "seceret-4c9b8",
            storageBucket: "seceret-4c9b8.firebasestorage.app",
            messagingSenderId: "627949762930",
            appId: "1:627949762930:web:3cc0b43c5166d73c5705eb"
        };

        if (typeof firebase === 'undefined') alert("Error: No Internet Connection. Firebase SDK failed to load.");
        else if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let gameId = null, myId = null, isHost = false, localState = {};

        [cite_start]// Power Unlock Configuration [cite: 215-220]
        const BOARDS = {
            5: [null, null, 'Policy Peek', 'Execution', 'Execution', null],
            6: [null, null, 'Policy Peek', 'Execution', 'Execution', null],
            7: [null, 'Investigate', 'Special Election', 'Execution', 'Execution', null],
            8: [null, 'Investigate', 'Special Election', 'Execution', 'Execution', null],
            9: ['Investigate', 'Investigate', 'Special Election', 'Execution', 'Execution', null],
            10: ['Investigate', 'Investigate', 'Special Election', 'Execution', 'Execution', null]
        };

        // --- SETUP ---
        function createGame() {
            isHost = true;
            gameId = Math.floor(Math.random()*9000+1000).toString();
            
            // Initial State
            const initialState = {
                state: 'LOBBY', 
                libPolicies: 0, 
                fasPolicies: 0, 
                electionTracker: 0,
                players: {}, 
                deck: createNewDeck(), 
                discard: [], 
                president: null, 
                chancellor: null, 
                lastChancellor: null, 
                lastPresident: null, 
                votes: {}, 
                legislativeHand: [], 
                executiveAction: null, 
                notification: "Waiting for players..."
            };

            db.ref(gameId).set(initialState);
            
            switchView('host-view');
            document.getElementById('display-game-code').innerText = gameId;
            
            db.ref(gameId).on('value', function(snap) { 
                localState = snap.val(); 
                if(localState) renderHost(); 
            });
            
            setInterval(hostLoop, 1000);
        }

        function joinGame() {
            const name = document.getElementById('playerName').value;
            if(!name) return alert("Name required");
            gameId = prompt("Enter Game Code:");
            if(!gameId) return;
            myId = 'p_'+Date.now();
            
            db.ref(gameId+'/players/'+myId).set({ 
                name: name, id: myId, alive: true, role: null, party: null 
            });
            
            switchView('player-view');
            document.getElementById('my-name-display').innerText = name;
            
            db.ref(gameId).on('value', function(snap) { 
                localState = snap.val(); 
                if(localState) renderPlayer(); 
            });
        }

        function startGame() {
            // DEBUG CHECK
            console.log("Attempting to start game...");
            
            if(!localState || !localState.players) return alert("Error: Game state not loaded. Try creating a new game.");
            const keys = Object.keys(localState.players);
            if(keys.length < 5) return alert(`Need 5-10 players. Currently have: ${keys.length}`);

            // Role Distribution
            let roles = ['HITLER'], numFas = 1;
            if(keys.length >= 7) numFas = 2;
            if(keys.length >= 9) numFas = 3;
            
            for(let i=0; i<numFas; i++) roles.push('FASCIST');
            while(roles.length < keys.length) roles.push('LIBERAL');
            roles.sort(() => Math.random() - 0.5);

            const updates = { 
                state: 'NOMINATION', 
                president: keys[Math.floor(Math.random()*keys.length)], 
                presidentOrder: keys, 
                notification: "Game Started. Check your Secret Roles." 
            };
            
            keys.forEach((k, i) => {
                updates[`players/${k}/role`] = roles[i];
                [cite_start]// [cite: 272] Hitler is Fascist party member
                updates[`players/${k}/party`] = (roles[i] === 'LIBERAL') ? 'LIBERAL' : 'FASCIST';
            });
            
            // Send update with Error Catching
            db.ref(gameId).update(updates)
                .then(() => console.log("Game started successfully."))
                .catch(error => alert("FIREBASE ERROR: " + error.message));
        }

        // --- HOST LOGIC ---
        function hostLoop() {
            if(!isHost || !localState || localState.state !== 'VOTING') return;
            const living = Object.values(localState.players).filter(p=>p.alive);
            const votes = localState.votes || {};
            if(Object.keys(votes).length >= living.length && living.length > 0) evaluateVote(votes);
        }

        function evaluateVote(votes) {
            let jas = Object.values(votes).filter(v=>v==='ja').length;
            let neins = Object.values(votes).filter(v=>v==='nein').length;
            
            if(jas > neins) {
                [cite_start]// [cite: 243] Hitler Elected Chancellor Win Condition
                if(localState.fasPolicies >= 3 && getRole(localState.chancellor) === 'HITLER') {
                    return endGame("FASCIST VICTORY: Hitler was Elected Chancellor!");
                }
                
                // Draw 3 cards
                drawCards(3).then(hand => {
                     db.ref(gameId).update({
                        state: 'LEGISLATIVE_PRES', 
                        legislativeHand: hand, 
                        votes: {}, 
                        electionTracker: 0,
                        notification: "Vote Passed. President is discarding a policy."
                    });
                });
            } else {
                advanceTurn(true); // Vote Failed
            }
        }

        function advanceTurn(failed) {
            failed = (failed === true); 
            
            let updates = {};
            if(failed) {
                let t = (localState.electionTracker || 0) + 1;
                updates.electionTracker = t;
                [cite_start]if(t >= 3) { // [cite: 320] Chaos
                    drawCards(1).then(hand => {
                        const top = hand[0];
                        updates.electionTracker = 0;
                        updates.libPolicies = localState.libPolicies + (top==='LIBERAL'?1:0);
                        updates.fasPolicies = localState.fasPolicies + (top==='FASCIST'?1:0);
                        updates.lastChancellor = null; 
                        updates.lastPresident = null; 
                        updates.notification = "CHAOS! 3 Failed Votes. Top Policy Enacted.";
                        
                        if(updates.libPolicies >= 5) return endGame("LIBERAL WIN: 5 Policies Enacted.");
                        if(updates.fasPolicies >= 6) return endGame("FASCIST WIN: 6 Policies Enacted.");
                        
                        db.ref(gameId).update(updates).then(() => {
                             advanceTurn(false);
                        });
                    });
                    return; 
                } else updates.notification = "Vote Failed. Election Tracker Advances.";
            } else {
                updates.lastPresident = localState.president;
                updates.lastChancellor = localState.chancellor;
            }

            // Rotate President
            let nextPres;
            if(localState.specialElectionReturn) {
                nextPres = localState.specialElectionReturn;
                updates.specialElectionReturn = null;
            } else {
                const order = localState.presidentOrder || Object.keys(localState.players); // Fallback
                let idx = (order.indexOf(localState.president)+1)%order.length;
                // Skip dead players
                if(localState.players[order[idx]]) {
                    let safety = 0;
                    while(!localState.players[order[idx]].alive && safety < 20) {
                        idx = (idx+1)%order.length;
                        safety++;
                    }
                }
                nextPres = order[idx];
            }
            
            updates.state = 'NOMINATION'; 
            updates.president = nextPres; 
            updates.chancellor = null; 
            updates.votes = {}; 
            updates.legislativeHand = [];
            
            db.ref(gameId).update(updates);
        }

        function enactPolicy(pol) {
            let updates = { legislativeHand: [] }, newLib = localState.libPolicies, newFas = localState.fasPolicies;
            if(pol === 'LIBERAL') {
                updates.libPolicies = ++newLib;
                if(newLib >= 5) return endGame("LIBERAL WIN: 5 Policies Enacted.");
                db.ref(gameId).update(updates).then(() => advanceTurn());
            } else {
                updates.fasPolicies = ++newFas;
                if(newFas >= 6) return endGame("FASCIST WIN: 6 Policies Enacted.");
                
                const pCount = Object.keys(localState.players).length;
                const power = (BOARDS[pCount] || BOARDS[5])[newFas - 1];
                if(power) {
                    updates.state = 'EXECUTIVE_ACTION'; 
                    updates.executiveAction = power;
                    updates.notification = `PRESIDENTIAL POWER: ${power}`;
                    db.ref(gameId).update(updates);
                } else db.ref(gameId).update(updates).then(() => advanceTurn());
            }
        }

        // --- DECK MANAGEMENT ---
        function createNewDeck() { 
            return Array(6).fill('LIBERAL').concat(Array(11).fill('FASCIST')).sort(()=>Math.random()-.5); 
        }

        function drawCards(num) {
            let deck = localState.deck || [];
            let discard = localState.discard || [];
            
            if(deck.length < num) {
                [cite_start]// [cite: 324] Reshuffle discard if deck empty
                if(discard.length === 0) deck = createNewDeck(); 
                else {
                    deck = deck.concat(discard).sort(()=>Math.random()-.5);
                    discard = [];
                }
            }
            
            const hand = deck.slice(0, num);
            const remaining = deck.slice(num);
            
            return db.ref(gameId).update({ deck: remaining, discard: discard }).then(() => hand);
        }
        
        function addToDiscard(cards) {
            let d = localState.discard || [];
            d = d.concat(cards);
            db.ref(gameId).update({ discard: d });
        }

        // --- CLIENT ACTIONS ---
        function handleVote(v) { db.ref(gameId+'/votes/'+myId).set(v); }
        
        function nominate(id) {
            const pc = Object.values(localState.players).filter(p=>p.alive).length;
            [cite_start]// [cite: 301] Term Limits
            if(id === localState.lastChancellor) return alert("Term Limited: Player was just Chancellor.");
            if(pc > 5 && id === localState.lastPresident) return alert("Term Limited: Player was just President.");
            
            db.ref(gameId).update({ chancellor: id, state: 'VOTING', notification: "VOTE NOW: Elect the Government." });
        }
        
        function discardPolicy(idx) {
            let hand = [...localState.legislativeHand];
            const discarded = hand.splice(idx, 1);
            addToDiscard(discarded); 
            
            if(localState.state === 'LEGISLATIVE_PRES') db.ref(gameId).update({ state: 'LEGISLATIVE_CHAN', legislativeHand: hand, notification: "Chancellor is enacting a policy." });
            else enactPolicy(hand[0]);
        }
        
        function proposeVeto() { db.ref(gameId).update({ state: 'VETO_CONSENT', notification: "Chancellor proposes Veto." }); }
        
        function answerVeto(agree) {
            if(agree) {
                [cite_start]// [cite: 382] Veto consented = Failed vote
                addToDiscard(localState.legislativeHand);
                advanceTurn(true);
            } else db.ref(gameId).update({ state: 'LEGISLATIVE_CHAN' }); // Rejected = must enact
        }

        function execAction(tid) {
            const act = localState.executiveAction;
            let up = { state: 'NOMINATION', executiveAction: null };
            if(act === 'Investigate') alert(`INVESTIGATION RESULT:\n${localState.players[tid].name} is a member of the ${localState.players[tid].party} party.`);
            else if(act === 'Execution') {
                if(getRole(tid) === 'HITLER') return endGame("HITLER ASSASSINATED. LIBERALS WIN.");
                up[`players/${tid}/alive`] = false;
                up['notification'] = `${localState.players[tid].name} has been Executed.`;
            } else if(act === 'Special Election') {
                up.state = 'NOMINATION'; 
                up.president = tid; 
                up.chancellor = null;
                up.specialElectionReturn = getNextPresidentIndex(); 
                up['notification'] = `Special Election! ${localState.players[tid].name} is President.`;
                db.ref(gameId).update(up); return;
            }
            db.ref(gameId).update(up).then(() => advanceTurn());
        }
        
        function peekCards() {
            const top3 = (localState.deck || []).slice(0, 3);
            alert(`TOP 3 POLICIES:\n1. ${top3[0]}\n2. ${top3[1]}\n3. ${top3[2]}`);
            db.ref(gameId).update({ state: 'NOMINATION', executiveAction: null }).then(() => advanceTurn());
        }
        
        // --- RENDER ---
        function renderHost() {
            // SHOW/HIDE BUTTON LOGIC
            const startBtn = document.getElementById('start-btn');
            const lobbyList = document.getElementById('lobby-list');
            const gameBoard = document.getElementById('game-board');

            if (localState.state === 'LOBBY') {
                startBtn.classList.remove('hidden');
                lobbyList.classList.remove('hidden');
                gameBoard.classList.add('hidden');
            } else {
                startBtn.classList.add('hidden');
                lobbyList.classList.add('hidden');
                gameBoard.classList.remove('hidden');
            }

            if(localState.notification) showNotif(localState.notification);
            if(localState.players) document.getElementById('lobby-list').innerHTML = Object.values(localState.players).map(p=>p.name).join(' â€¢ ');
            
            // Render Tracks
            const pc = Object.keys(localState.players||{}).length || 5;
            const powers = BOARDS[pc] || BOARDS[5];
            renderTrack('lib-track', 5, localState.libPolicies, 'filled-lib');
            renderTrack('fas-track', 6, localState.fasPolicies, 'filled-fas', powers);
            
            document.getElementById('tracker-count').innerText = localState.electionTracker;
            document.getElementById('deck-count').innerText = localState.deck ? localState.deck.length : 0;
            
            // Update Status Text
            if(localState.state === 'LOBBY') {
                document.getElementById('game-status').innerText = "Status: Waiting for players...";
            } else if(localState.president) {
                document.getElementById('game-status').innerText = `President: ${getName(localState.president)}`;
                if(localState.chancellor) document.getElementById('gov-display').innerText = `Chancellor Nominee: ${getName(localState.chancellor)}`;
                else document.getElementById('gov-display').innerText = "Nominating Chancellor...";
            }
        }

        function renderPlayer() {
            if(!localState.players || !localState.players[myId]) return;
            const me = localState.players[myId];
            const amPres = localState.president === myId, amChan = localState.chancellor === myId;
            
            document.getElementById('role-text').innerText = me.role;
            document.getElementById('role-desc').innerText = me.role === 'LIBERAL' ? "Sustain the government." : "Sabotage and elect Hitler.";
            document.getElementById('my-role-card').className = 'secret-role ' + (me.role==='LIBERAL'?'role-liberal':'role-fascist');
            
            const all = Object.values(localState.players);
            if(me.role === 'FASCIST') document.getElementById('team-info').innerText = "Fascists: " + all.filter(p=>p.role==='FASCIST'||p.role==='HITLER').map(p=>p.name).join(', ');
            else if(me.role === 'HITLER' && all.length <= 6) document.getElementById('team-info').innerText = "Teammate: " + all.filter(p=>p.role==='FASCIST').map(p=>p.name).join(', ');
            else document.getElementById('team-info').innerText = "Trust no one.";

            const ctrl = document.getElementById('active-controls');
            const btns = document.getElementById('control-btns');
            const wait = document.getElementById('wait-msg');
            ctrl.classList.add('hidden'); wait.style.display = 'block'; btns.innerHTML = '';
            
            if(!me.alive) { wait.innerText = "YOU HAVE BEEN EXECUTED."; return; }

            // Dynamic Controls based on State
            if(localState.state === 'NOMINATION' && amPres) {
                showCtrl("NOMINATION", "Nominate a Chancellor Candidate", Object.values(localState.players).filter(p=>p.alive && p.id!==myId).map(p=>({txt:p.name, fn:`nominate('${p.id}')`})));
            } else if(localState.state === 'VOTING' && !localState.votes?.[myId]) {
                showCtrl("ELECTION", `Vote on Pres. ${getName(localState.president)} & Chan. ${getName(localState.chancellor)}`, [{txt:"JA! (Yes)", cls:"btn-ja", fn:"handleVote('ja')"}, {txt:"NEIN (No)", cls:"btn-nein", fn:"handleVote('nein')"}]);
            } else if(localState.state === 'LEGISLATIVE_PRES' && amPres) {
                showCtrl("LEGISLATIVE SESSION", "Discard 1 Policy. Pass 2 to Chancellor.", localState.legislativeHand.map((c,i)=>({txt:c, cls:c==='LIBERAL'?'btn-ja':'btn-nein', fn:`discardPolicy(${i})`})));
            } else if(localState.state === 'LEGISLATIVE_CHAN' && amChan) {
                let opts = localState.legislativeHand.map((c,i)=>({txt:c, cls:c==='LIBERAL'?'btn-ja':'btn-nein', fn:`discardPolicy(${i})`}));
                if(localState.fasPolicies === 5) opts.push({txt:"PROPOSE VETO", cls:"btn-action", fn:"proposeVeto()"});
                showCtrl("LEGISLATIVE SESSION", "Discard 1. Enact the other.", opts);
            } else if(localState.state === 'VETO_CONSENT' && amPres) {
                showCtrl("VETO PROPOSAL", "Chancellor proposed a Veto. Do you agree?", [{txt:"AGREE (Discard All)", cls:"btn-ja", fn:"answerVeto(true)"}, {txt:"REJECT (Must Enact)", cls:"btn-nein", fn:"answerVeto(false)"}]);
            } else if(localState.state === 'EXECUTIVE_ACTION' && amPres) {
                const act = localState.executiveAction;
                if(act === 'Policy Peek') showCtrl("POWER: POLICY PEEK", "Peek at the top 3 cards.", [{txt:"PEEK", cls:"btn-action", fn:"peekCards()"}]);
                else showCtrl(`POWER: ${act.toUpperCase()}`, `Select a player to target.`, Object.values(localState.players).filter(p=>p.alive && p.id!==myId).map(p=>({txt:p.name, cls:"btn-action", fn:`execAction('${p.id}')`})));
            }

            function showCtrl(title, desc, bArr) {
                wait.style.display = 'none'; ctrl.classList.remove('hidden');
                document.getElementById('control-title').innerText = title;
                document.getElementById('control-desc').innerText = desc;
                bArr.forEach(b => btns.innerHTML += `<button class="btn ${b.cls||''}" onclick="${b.fn}">${b.txt}</button>`);
            }
        }

        // Utils
        function switchView(id) { document.getElementById('setup-screen').classList.add('hidden'); document.getElementById(id).classList.remove('hidden'); }
        function getRole(id) { return localState.players[id]?.role; }
        function getName(id) { return localState.players[id]?.name || 'Unknown'; }
        function getNextPresidentIndex() { 
            const o = localState.presidentOrder; let i = (o.indexOf(localState.president)+1)%o.length;
            while(!localState.players[o[i]].alive) i=(i+1)%o.length; return localState.players[o[i]].id;
        }
        function showNotif(msg) { const e=document.getElementById('notification-area'); e.innerText=msg; e.style.display='block'; setTimeout(()=>e.style.display='none', 4000); }
        function endGame(msg) { db.ref(gameId).update({state:'GAMEOVER', notification:msg}); alert(msg); }
        function toggleRole() { const e=document.getElementById('my-role-card'); e.style.display=(e.style.display==='block'?'none':'block'); }
        
        function renderTrack(id, max, curr, cls, powers) {
            const div = document.getElementById(id); div.innerHTML = '';
            for(let i=0; i<max; i++) {
                let d = document.createElement('div'); d.className = `policy-slot ${i<curr?cls:''}`;
                if(powers && powers[i]) d.innerHTML = `<span class="power-text">${powers[i]}</span>`;
                div.appendChild(d);
            }
        }
    </script>
</body>
</html>
