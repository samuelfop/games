<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - 1932 Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Germania+One&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --liberal: #65aadd; 
            --fascist: #d64d4d;
            --bg: #2b2b2b;
            --paper: #f4e4bc; /* Aged paper look */
            --text: #333;
        }
        
        body { 
            font-family: 'Roboto Mono', monospace; 
            background: var(--bg); 
            color: #eee; 
            text-align: center; 
            margin: 0; 
            padding: 20px; 
        }
        
        h1, h2, h3 { font-family: 'Germania One', cursive; letter-spacing: 1px; }

        .hidden { display: none !important; }
        
        /* CARD STYLING */
        .card { 
            background: var(--paper); 
            color: var(--text);
            padding: 15px; 
            margin: 10px; 
            display: inline-block; 
            border-radius: 2px; 
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
        }
        
        /* BUTTONS */
        .btn { 
            padding: 15px 25px; 
            font-size: 1.1em; 
            font-family: 'Germania One', cursive;
            cursor: pointer; 
            background: #555; 
            color: white; 
            border: 1px solid #777; 
            margin: 8px; 
            box-shadow: 2px 2px 0px #222;
            transition: transform 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: none; }
        
        .btn-ja { background: var(--paper); color: var(--fascist); border: 4px solid var(--fascist); font-size: 1.5em; transform: rotate(-2deg); }
        .btn-nein { background: var(--paper); color: var(--text); border: 4px solid var(--text); font-size: 1.5em; transform: rotate(2deg); }
        .btn-action { background: #d4af37; color: black; border: 2px solid #8a7018; }
        
        /* BOARD */
        .track { 
            background: #e0d0a0; 
            color: #333; 
            padding: 15px; 
            border-radius: 4px; 
            border: 1px solid #555;
            display: inline-block;
        }
        
        .policy-slot { 
            width: 70px; height: 100px; 
            border: 2px dashed #888; 
            display: inline-block; margin: 5px; 
            line-height: 100px; font-weight: bold; font-size: 1.5em; position: relative;
            background: rgba(0,0,0,0.05);
        }
        .policy-slot.filled-lib { background: var(--liberal); border: 2px solid #fff; color: white; }
        .policy-slot.filled-fas { background: var(--fascist); border: 2px solid #fff; color: white; }
        
        .power-icon { 
            position: absolute; bottom: 5px; left: 0; width: 100%; 
            font-size: 0.3em; line-height: 1.1em; font-family: sans-serif; 
            color: #333; font-weight: bold; text-transform: uppercase;
        }
        
        /* ROLES */
        .secret-role { 
            padding: 20px; border: 10px solid; 
            display: none; margin: 20px auto; max-width: 320px; 
            background: var(--paper); color: #222;
        }
        .role-liberal { border-color: var(--liberal); }
        .role-fascist { border-color: var(--fascist); }
        
        /* NOTIFICATIONS */
        #notification-area { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px;
            background: #fff; color: #000; border: 4px solid #000;
            padding: 15px; font-weight: bold; font-size: 1.2em;
            display: none; z-index: 1000; 
            box-shadow: 10px 10px 0px rgba(0,0,0,0.8);
            font-family: 'Germania One', cursive;
        }
    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="setup-screen">
        <h1 style="font-size: 4em; margin-bottom: 0; color: #d64d4d; text-shadow: 2px 2px 0 #000;">SECRET HITLER</h1>
        <p style="margin-top:0; font-style: italic;">The year is 1932. The place is pre-WWII Germany.</p>
        <br>
        <div class="card">
            <h3>IDENTIFICATION</h3>
            <input type="text" id="playerName" placeholder="Enter Your Name" style="padding:10px; font-family:inherit;">
            <br><br>
            <button class="btn" onclick="createGame()">Create Game (Host)</button>
            <button class="btn" onclick="joinGame()">Join Game (Player)</button>
        </div>
        <div id="credits-footer" style="margin-top: 50px; font-size: 0.8em; color: #888; border-top: 1px solid #444; padding-top: 20px;">
    <p>
        <strong>Secret Hitler</strong> was created by Mike Boxleiter, Tommy Maranges, Max Temkin, and Mac Schubert.
    </p>
    <p>
        This is an online adaptation of the original board game. 
        <a href="https://www.secrethitler.com" target="_blank" style="color: #65aadd;">Visit the official site.</a>
    </p>
    <p>
        Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" style="color: #d64d4d;">CC BY-NC-SA 4.0</a>.
    </p>
</div>
    </div>

    <div id="host-view" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 20px;">
            <h2 style="font-family: sans-serif;">CODE: <span id="display-game-code" style="color:gold;"></span></h2>
            <h2 id="game-status" style="color: #f4e4bc;">Status: Waiting for players...</h2>
        </div>
        
        <div id="lobby-list" style="color: #aaa; margin-bottom: 20px;"></div>
        <button id="start-btn" class="btn hidden" onclick="startGame()" style="background: #d64d4d; font-size: 1.5em;">BEGIN GAME</button>
        
        <div id="game-board" class="hidden">
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--liberal); margin-bottom: 5px;">LIBERAL POLICIES</h3>
                <div id="lib-track" class="track"></div>
            </div>

            <div>
                <h3 style="color: var(--fascist); margin-bottom: 5px;">FASCIST POLICIES</h3>
                <div id="fas-track" class="track"></div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 40px; margin-top: 20px; font-size: 1.1em;">
                <div class="card" style="margin:0;">
                    <span style="font-weight:bold;">ELECTION TRACKER</span><br>
                    <span id="tracker-count" style="color:red; font-size:1.5em;">0</span> / 3
                </div>
                <div class="card" style="margin:0;">
                    <span style="font-weight:bold;">POLICY DECK</span><br>
                    <span id="deck-count" style="font-size:1.5em;">--</span>
                </div>
            </div>
            
            <div id="government-display" style="margin-top: 30px; font-size: 1.4em; color: #f4e4bc; border-top: 1px solid #555; padding-top: 20px;"></div>
        </div>
    </div>

    <div id="player-view" class="hidden">
        <h2 id="my-name-display" style="text-transform: uppercase; color: #f4e4bc;">PLAYER</h2>
        
        <button class="btn" onclick="toggleRole()">open/close secret role</button>
        
        <div id="my-role-card" class="secret-role">
            <div style="border-bottom: 2px solid #333; margin-bottom: 10px; padding-bottom:5px;">
                <span style="font-size: 0.8em; text-transform: uppercase;">Official Party Membership</span>
            </div>
            <h1 id="role-text" style="font-size: 2.5em; margin: 10px 0;">ROLE</h1>
            <p id="role-flavor" style="font-style: italic; font-size: 0.9em;"></p>
            <hr style="border: 1px dashed #333;">
            <p id="teammates-info" style="font-weight: bold; font-size: 0.9em;"></p>
        </div>

        <div id="player-action-area" style="margin-top: 30px;">
            <div id="instruction-card" class="card" style="width: 90%; max-width: 400px; display: none;">
                <h3 id="player-instruction-title" style="margin:0; border-bottom:1px solid #333; padding-bottom:5px;">INSTRUCTION</h3>
                <p id="player-instruction-body" style="font-size: 1.1em;"></p>
            </div>
            <div id="controls" style="display: flex; flex-direction: column; align-items: center; margin-top: 15px;"></div>
            <p id="wait-message" style="color: #888; font-style: italic;">Waiting for the government...</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcn5aaeBbPfWRNm_xremdSHFuI6S4_VCs",
            authDomain: "seceret-4c9b8.firebaseapp.com",
            databaseURL: "https://seceret-4c9b8-default-rtdb.firebaseio.com",
            projectId: "seceret-4c9b8",
            storageBucket: "seceret-4c9b8.firebasestorage.app",
            messagingSenderId: "627949762930",
            appId: "1:627949762930:web:3cc0b43c5166d73c5705eb"
        };

        if (typeof firebase === 'undefined') alert("Error: Internet connection required for Firebase.");
        else if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GAME STATE ---
        let gameId = null;
        let myId = null;
        let isHost = false;
        let localState = {};

        // Executive Actions Board 
        // 5-6: Peek, Kill, Kill
        // 7-8: Investigate, Special Election, Kill, Kill
        // 9-10: Investigate, Investigate, Special Election, Kill, Kill
        const BOARDS = {
            5: [null, null, 'Policy Peek', 'Execution', 'Execution', null],
            6: [null, null, 'Policy Peek', 'Execution', 'Execution', null],
            7: [null, 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', null],
            8: [null, 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', null],
            9: ['Investigate Loyalty', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', null],
            10: ['Investigate Loyalty', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', null]
        };

        // --- SETUP ---

function createGame() {
    isHost = true;
    gameId = Math.floor(Math.random() * 9000 + 1000).toString();
    
    // WE USE THE NEW FUNCTION HERE:
    db.ref(gameId).set({
        state: 'LOBBY', 
        libPolicies: 0,
        fasPolicies: 0,
        electionTracker: 0,
        players: {},
        deck: createInitialDeck(), // <--- CHANGED FROM shuffleDeck()
        discard: [],
        president: null,
        chancellor: null,
        lastChancellor: null,
        lastPresident: null,
        votes: {},
        legislativeHand: [],
        executiveAction: null,
        notification: "The year is 1932. Waiting for players..."
    });

    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('host-view').classList.remove('hidden');
    document.getElementById('display-game-code').innerText = gameId;

    db.ref(gameId).on('value', snap => {
        localState = snap.val();
        if (localState) renderHost();
    });

    setInterval(hostGameLoop, 1000);
}

        function joinGame() {
            const name = document.getElementById('playerName').value;
            if(!name) return alert("Please enter your name.");
            gameId = prompt("Enter Game Code from the TV:");
            if(!gameId) return;

            myId = 'player_' + Date.now();
            db.ref(gameId + '/players/' + myId).set({
                name: name, role: null, party: null, id: myId, alive: true
            });

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('player-view').classList.remove('hidden');
            document.getElementById('my-name-display').innerText = name;

            db.ref(gameId).on('value', snap => {
                localState = snap.val();
                if (localState) renderPlayer();
            });
        }

        function startGame() {
            if (!localState || !localState.players) return alert("Wait for politicians to assemble.");
            const playerKeys = Object.keys(localState.players);
            const count = playerKeys.length;
            if (count < 5 || count > 10) return alert(`Game requires 5-10 players. You have ${count}.`);

            // Setup Table
            let roles = [];
            let numFascists = 1; // 5-6 players (1 Fas + Hitler)
            if(count >= 7) numFascists = 2; // 7-8 players (2 Fas + Hitler)
            if(count >= 9) numFascists = 3; // 9-10 players (3 Fas + Hitler)
            
            roles.push('HITLER');
            for(let i=0; i<numFascists; i++) roles.push('FASCIST');
            while(roles.length < count) roles.push('LIBERAL');
            roles = roles.sort(() => Math.random() - 0.5);

            const updates = {};
            updates['state'] = 'NOMINATION';
            updates['president'] = playerKeys[Math.floor(Math.random() * count)];
            updates['presidentOrder'] = playerKeys;
            updates['notification'] = "The game begins. Check your Secret Role.";

            playerKeys.forEach((key, index) => {
                const role = roles[index];
                updates[`players/${key}/role`] = role;
                // Hitler's Party Membership is Fascist
                updates[`players/${key}/party`] = (role === 'LIBERAL') ? 'LIBERAL' : 'FASCIST';
            });

            db.ref(gameId).update(updates);
        }

        // --- HOST LOGIC ---

        function hostGameLoop() {
            if (!isHost || !localState || !localState.state) return;

            if (localState.state === 'VOTING') {
                const livingPlayers = Object.values(localState.players).filter(p => p.alive);
                const votes = localState.votes || {};
                if (Object.keys(votes).length >= livingPlayers.length && livingPlayers.length > 0) {
                    evaluateVote(votes);
                }
            }
        }



        function evaluateVote(votes) {
    let jas = Object.values(votes).filter(v => v === 'ja').length;
    let neins = Object.values(votes).filter(v => v === 'nein').length;

    if (jas > neins) { 
        // --- VOTE PASSES ---

        // 1. Check Win Condition: Hitler elected Chancellor after 3 Fascist policies 
        if (localState.fasPolicies >= 3 && getRole(localState.chancellor) === 'HITLER') {
            return endGame("FASCIST VICTORY: Hitler was elected Chancellor!");
        }

        // 2. Deck Management: Reshuffle if fewer than 3 cards remain 
        let deck = localState.deck || [];
        let discard = localState.discard || [];

        if (deck.length < 3) {
            // Combine remaining deck and discards, then shuffle
            deck = shuffle([...deck, ...discard]);
            discard = []; // Empty the discard pile in the database
        }
        
        // 3. Draw 3 Cards [cite: 125]
        const hand = deck.slice(0, 3);
        const remainingDeck = deck.slice(3);

        // 4. Update Database
        db.ref(gameId).update({
            state: 'LEGISLATIVE_PRES',
            legislativeHand: hand,
            deck: remainingDeck,
            discard: discard, 
            votes: {},
            electionTracker: 0, // Reset tracker on successful election [cite: 116]
            notification: "The Government is elected. Legislative Session begins."
        });

    } else { 
        // --- VOTE FAILS ---
        advanceTurn(true); 
    }
}



        function advanceTurn(voteFailed = false) {
    let updates = {};
    
    if (voteFailed) {
        // --- ELECTION TRACKER LOGIC ---
        let tracker = (localState.electionTracker || 0) + 1;
        updates.electionTracker = tracker; // Advance tracker [cite: 110]
        
        if (tracker >= 3) {
            // --- CHAOS (3 Failed Votes) --- [cite: 111]
            let deck = localState.deck || [];
            let discard = localState.discard || [];

            // Safety Check: If deck is empty during chaos, we must reshuffle first 
            if (deck.length < 1) {
                deck = shuffle([...discard]);
                discard = [];
            }

            const topCard = deck[0]; // Reveal top policy [cite: 112]
            
            updates.deck = deck.slice(1);
            updates.discard = discard;
            updates.electionTracker = 0; // Reset tracker 
            
            // Enact the policy
            const isLib = (topCard === 'LIBERAL');
            updates.libPolicies = localState.libPolicies + (isLib ? 1 : 0);
            updates.fasPolicies = localState.fasPolicies + (!isLib ? 1 : 0);
            
            // In Chaos, all players become eligible (reset term limits) 
            updates.lastChancellor = null; 
            updates.lastPresident = null;
            
            updates.notification = `CHAOS! The frustrated populace enacts a ${topCard} Policy.`;

            // Check Win Conditions immediately [cite: 29, 32]
            if (updates.libPolicies >= 5) return endGame("LIBERAL VICTORY: 5 Policies Enacted.");
            if (updates.fasPolicies >= 6) return endGame("FASCIST VICTORY: 6 Policies Enacted.");
            
            // Note: Presidential Powers are IGNORED during chaos 
        } else {
            updates.notification = "The Vote Fails. The Election Tracker advances.";
        }
    } else {
        // --- SUCCESSFUL TURN ---
        // If the turn advanced normally (policy enacted), update Term Limits [cite: 92]
        updates.lastPresident = localState.president;
        updates.lastChancellor = localState.chancellor;
    }

    // --- ROTATE PRESIDENT ---
    let nextPres;
    
    // Check if we are returning from a Special Election [cite: 157]
    if (localState.specialElectionReturn) {
        nextPres = localState.specialElectionReturn;
        updates.specialElectionReturn = null;
    } else {
        // Standard Clockwise Rotation [cite: 87]
        const pOrder = localState.presidentOrder;
        const currIdx = pOrder.indexOf(localState.president);
        let nextIdx = (currIdx + 1) % pOrder.length;
        
        // Skip dead players [cite: 167]
        let safety = 0;
        while (!localState.players[pOrder[nextIdx]].alive && safety < 20) {
            nextIdx = (nextIdx + 1) % pOrder.length;
            safety++;
        }
        nextPres = pOrder[nextIdx];
    }

    // Prepare for next round
    updates.state = 'NOMINATION';
    updates.president = nextPres;
    updates.chancellor = null;
    updates.votes = {};
    updates.legislativeHand = [];
    
    db.ref(gameId).update(updates);
}

        function enactPolicy(policy) {
            let updates = { legislativeHand: [] };
            let newLib = localState.libPolicies;
            let newFas = localState.fasPolicies;

            if (policy === 'LIBERAL') {
                newLib++;
                updates.libPolicies = newLib;
                if (newLib >= 5) return endGame("LIBERAL VICTORY: The Liberals have enacted 5 policies.");
                db.ref(gameId).update(updates).then(() => advanceTurn());
            } else {
                newFas++;
                updates.fasPolicies = newFas;
                if (newFas >= 6) return endGame("FASCIST VICTORY: The Fascists have enacted 6 policies.");

                // Check for Presidential Powers 
                const playerCount = Object.keys(localState.players).length;
                const board = BOARDS[playerCount] || BOARDS[5];
                const power = board[newFas - 1];

                if (power) {
                    updates.state = 'EXECUTIVE_ACTION';
                    updates.executiveAction = power;
                    updates.notification = `PRESIDENTIAL POWER UNLOCKED: ${power.toUpperCase()}`;
                    db.ref(gameId).update(updates);
                } else {
                    db.ref(gameId).update(updates).then(() => advanceTurn());
                }
            }
        }

        // --- PLAYER ACTIONS ---

        function handleVote(vote) { db.ref(gameId + '/votes/' + myId).set(vote); }

        function nominate(targetId) {
            // Term Limits
            const pCount = Object.values(localState.players).filter(p => p.alive).length;
            if (targetId === localState.lastChancellor) return alert("This player was just Chancellor (Term Limited).");
            if (pCount > 5 && targetId === localState.lastPresident) return alert("This player was just President (Term Limited).");
            
            db.ref(gameId).update({ 
                chancellor: targetId, state: 'VOTING',
                notification: `The Election is underway.` 
            });
        }





function legislationDiscard(index) {
    let hand = [...localState.legislativeHand];
    // Remove card from hand and save it
    const discardedCard = hand.splice(index, 1)[0]; 
    
    // Add to discard pile in DB
    const currentDiscard = localState.discard || [];
    const newDiscard = [...currentDiscard, discardedCard];

    if (localState.state === 'LEGISLATIVE_PRES') {
        // President Discarded -> Pass 2 cards to Chancellor [cite: 126]
        db.ref(gameId).update({ 
            state: 'LEGISLATIVE_CHAN', 
            legislativeHand: hand,
            discard: newDiscard, // SAVE DISCARD
            notification: "The Chancellor is now enacting a policy."
        });
    } else {
        // Chancellor Discarded -> Enact the remaining one [cite: 126]
        db.ref(gameId).update({ 
            discard: newDiscard // SAVE DISCARD
        }).then(() => {
            enactPolicy(hand[0]);
        });
    }
}

        function proposeVeto() { 
            db.ref(gameId).update({ 
                state: 'VETO_CONSENT',
                notification: "The Chancellor wishes to Veto the agenda." 
            }); 
        }

        function answerVeto(agree) {
            if (agree) advanceTurn(true); // Veto = Failed Vote
            else db.ref(gameId).update({ state: 'LEGISLATIVE_CHAN' }); // Must enact
        }

        function performExecutiveAction(targetId) {
            const action = localState.executiveAction;
            let updates = { state: 'NOMINATION', executiveAction: null }; 

            if (action === 'Investigate Loyalty') {
                const party = localState.players[targetId].party;
                alert(`INVESTIGATION RESULTS:\n\nPlayer: ${getName(targetId)}\nParty Membership: ${party}`); 
            } 
            else if (action === 'Execution') {
                // I formally execute
                if (getRole(targetId) === 'HITLER') return endGame("LIBERAL VICTORY: Hitler has been assassinated!");
                updates[`players/${targetId}/alive`] = false;
                updates.notification = `${getName(targetId)} has been executed.`;
            } 
            else if (action === 'Special Election') {
                updates.state = 'NOMINATION';
                updates.president = targetId;
                updates.chancellor = null;
                updates.specialElectionReturn = getNextPresidentIndex(); 
                updates.notification = `Special Election! ${getName(targetId)} takes the Presidency.`;
                db.ref(gameId).update(updates);
                return;
            }
            db.ref(gameId).update(updates).then(() => { if (action !== 'Special Election') advanceTurn(); });
        }

        function peekPolicy() {
            const top3 = localState.deck.slice(0, 3);
            alert(`POLICY PEEK:\n\n1. ${top3[0]}\n2. ${top3[1]}\n3. ${top3[2]}`);
            db.ref(gameId).update({ state: 'NOMINATION', executiveAction: null }).then(() => advanceTurn());
        }

        // --- RENDER ---

        function renderHost() {
            document.getElementById('start-btn').classList.toggle('hidden', localState.state !== 'LOBBY');
            document.getElementById('game-board').classList.toggle('hidden', localState.state === 'LOBBY');
            
            if(localState.notification) showNotification(localState.notification);

            if (localState.players && localState.state === 'LOBBY') {
                const pList = Object.values(localState.players).map(p => p.name).join(' â€¢ ');
                document.getElementById('lobby-list').innerHTML = pList;
            }

            const pCount = Object.keys(localState.players || {}).length || 5;
            const powers = BOARDS[pCount] || BOARDS[5];
            
            renderTrack('lib-track', 5, localState.libPolicies, 'filled-lib', []);
            renderTrack('fas-track', 6, localState.fasPolicies, 'filled-fas', powers);
            
            document.getElementById('tracker-count').innerText = localState.electionTracker;
            document.getElementById('deck-count').innerText = localState.deck ? localState.deck.length : 0;
            
            if(localState.president) {
                let txt = `President ${getName(localState.president)}`;
                if(localState.chancellor) txt += ` has nominated Chancellor ${getName(localState.chancellor)}`;
                document.getElementById('government-display').innerText = txt;
            }
        }

function renderPlayer() {
            if (!localState.players || !localState.players[myId]) return;
            const me = localState.players[myId];
            const amPres = (localState.president === myId);
            const amChan = (localState.chancellor === myId);

            // --- ROLE CARD DISPLAY ---
            const roleEl = document.getElementById('my-role-card');
            const roleText = document.getElementById('role-text');
            const roleFlavor = document.getElementById('role-flavor');
            const teamInfo = document.getElementById('teammates-info');
            
            if(me.role) {
                roleText.innerText = me.role;
                roleEl.className = 'secret-role ' + (me.role === 'LIBERAL' ? 'role-liberal' : 'role-fascist');
                
                // FLAVOR: Thematic Goal Text
                if (me.role === 'LIBERAL') roleFlavor.innerText = "Sustain the Liberal government. You suspect everyone.";
                else if (me.role === 'FASCIST') roleFlavor.innerText = "Sabotage the government. Coordinate to elect Hitler.";
                else roleFlavor.innerText = "Seize power. If you are elected Chancellor after 3 Fascist policies, you win.";

                // MECHANIC: Teammate Awareness
                const all = Object.values(localState.players);
                if (me.role === 'FASCIST') {
                    // Fascists see everyone
                    const others = all.filter(p => (p.role === 'FASCIST' || p.role === 'HITLER') && p.id !== myId);
                    teamInfo.innerText = "ALLIES: " + others.map(p => `${p.name} (${p.role})`).join(', ');
                } else if (me.role === 'HITLER' && all.length <= 6) {
                    // Hitler sees Fascist only in small games
                    const others = all.filter(p => p.role === 'FASCIST');
                    teamInfo.innerText = "YOUR FASCIST: " + others.map(p => p.name).join(', ');
                } else {
                    // Liberals and Hitler (in large games) see nothing
                    teamInfo.innerText = "Trust no one.";
                }
            }

            // --- CONTROLS & INSTRUCTIONS ---
            const controls = document.getElementById('controls');
            const instCard = document.getElementById('instruction-card');
            const instTitle = document.getElementById('player-instruction-title');
            const instBody = document.getElementById('player-instruction-body');
            const waitMsg = document.getElementById('wait-message');
            
            controls.innerHTML = '';
            instCard.style.display = 'none';
            waitMsg.style.display = 'block';

            if (!me.alive) {
                waitMsg.innerText = "YOU HAVE BEEN EXECUTED.";
                return;
            }

            // 1. NOMINATION PHASE
            if (localState.state === 'NOMINATION') {
                if (amPres) {
                    waitMsg.style.display = 'none';
                    instCard.style.display = 'block';
                    instTitle.innerText = "PRESIDENTIAL CANDIDATE";
                    instBody.innerText = "You must nominate a Chancellor. Choose carefully.";
                    
                    Object.values(localState.players).forEach(p => {
                        if (p.id !== myId && p.alive) {
                            controls.innerHTML += `<button class="btn" onclick="nominate('${p.id}')">${p.name}</button>`;
                        }
                    });
                } else {
                    waitMsg.innerText = `President ${getName(localState.president)} is selecting a Chancellor...`;
                }
            }
            // 2. VOTING PHASE
            else if (localState.state === 'VOTING') {
                if (!localState.votes || !localState.votes[myId]) {
                    waitMsg.style.display = 'none';
                    instCard.style.display = 'block';
                    instTitle.innerText = "ELECTION DAY";
                    instBody.innerText = `Vote on the proposed government:\nPresident ${getName(localState.president)} & Chancellor ${getName(localState.chancellor)}`;
                    controls.innerHTML = `
                        <button class="btn btn-ja" onclick="handleVote('ja')">Ja! (Yes)</button>
                        <button class="btn btn-nein" onclick="handleVote('nein')">Nein (No)</button>
                    `;
                } else {
                    waitMsg.innerText = "Ballot cast. Waiting for the rest of parliament...";
                }
            }
            // 3. LEGISLATIVE SESSION (PRESIDENT)
            else if (localState.state === 'LEGISLATIVE_PRES' && amPres) {
                waitMsg.style.display = 'none';
                instCard.style.display = 'block';
                instTitle.innerText = "PRESIDENTIAL SESSION";
                instBody.innerText = "Draw 3 Policies. Discard 1. Pass 2 to the Chancellor in secret.";
                localState.legislativeHand.forEach((card, i) => {
                    controls.innerHTML += `<button class="btn ${card==='LIBERAL'?'btn-ja':'btn-nein'}" onclick="legislationDiscard(${i})">Discard ${card}</button>`;
                });
            }
            // 4. LEGISLATIVE SESSION (CHANCELLOR)
            else if (localState.state === 'LEGISLATIVE_CHAN' && amChan) {
                waitMsg.style.display = 'none';
                instCard.style.display = 'block';
                instTitle.innerText = "CHANCELLOR'S DECISION";
                instBody.innerText = "The President handed you 2 Policies. Discard 1. The remaining Policy will be ENACTED.";
                localState.legislativeHand.forEach((card, i) => {
                    controls.innerHTML += `<button class="btn ${card==='LIBERAL'?'btn-ja':'btn-nein'}" onclick="legislationDiscard(${i})">Discard ${card}</button>`;
                });
                if (localState.fasPolicies === 5) {
                     controls.innerHTML += `<br><button class="btn btn-action" onclick="proposeVeto()">I WISH TO VETO</button>`;
                }
            }
            // 5. VETO
            else if (localState.state === 'VETO_CONSENT' && amPres) {
                waitMsg.style.display = 'none';
                instCard.style.display = 'block';
                instTitle.innerText = "VETO PROPOSED";
                instBody.innerText = "The Chancellor wishes to discard both policies. Do you consent to this paralysis?";
                controls.innerHTML = `
                    <button class="btn btn-ja" onclick="answerVeto(true)">I AGREE (Discard All)</button>
                    <button class="btn btn-nein" onclick="answerVeto(false)">I DO NOT CONSENT</button>
                `;
            }
            // 6. EXECUTIVE ACTION
            else if (localState.state === 'EXECUTIVE_ACTION' && amPres) {
                waitMsg.style.display = 'none';
                instCard.style.display = 'block';
                const act = localState.executiveAction;
                instTitle.innerText = "PRESIDENTIAL POWER";
                instBody.innerText = `The Fascist power has grown. You must use the power: ${act.toUpperCase()}`;
                
                if (act === 'Policy Peek') {
                    controls.innerHTML = `<button class="btn btn-action" onclick="peekPolicy()">Peek Top 3 Policies</button>`;
                } else {
                    let actionVerb = "Select";
                    if(act === 'Execution') actionVerb = "EXECUTE";
                    if(act === 'Investigate Loyalty') actionVerb = "INVESTIGATE";
                    
                    Object.values(localState.players).forEach(p => {
                        if (p.id !== myId && p.alive) { 
                            controls.innerHTML += `<button class="btn btn-action" onclick="performExecutiveAction('${p.id}')">${actionVerb} ${p.name.toUpperCase()}</button>`;
                        }
                    });
                }
            }
        }

        // --- UTILS ---

// 1. Generic Shuffle Function (The logic)
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex != 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// 2. Initial Deck Creator (The factory)
function createInitialDeck() {
    return shuffle(Array(6).fill('LIBERAL').concat(Array(11).fill('FASCIST')));
}

function getRole(id) { return localState.players[id] ? localState.players[id].role : null; }
function getName(id) { return localState.players[id] ? localState.players[id].name : 'Unknown'; }

function renderTrack(id, max, curr, cls, powers) {
    const div = document.getElementById(id);
    div.innerHTML = '';
    for(let i=0; i<max; i++) {
        let d = document.createElement('div');
        d.className = `policy-slot ${i<curr ? cls : ''}`;
        d.innerText = i+1;
        if (powers && powers[i]) {
            let pSpan = document.createElement('span');
            pSpan.className = 'power-icon';
            pSpan.innerText = powers[i];
            d.appendChild(pSpan);
        }
        div.appendChild(d);
    }
}

function showNotification(msg) {
    const el = document.getElementById('notification-area');
    el.innerText = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

function endGame(msg) {
    db.ref(gameId).update({ state: 'GAMEOVER', notification: msg });
    showNotification(msg);
    alert(msg);
}

function toggleRole() {
    const el = document.getElementById('my-role-card');
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}

function getNextPresidentIndex() {
     const pOrder = localState.presidentOrder;
     const currIdx = pOrder.indexOf(localState.president);
     let nextIdx = (currIdx + 1) % pOrder.length;
     while (!localState.players[pOrder[nextIdx]].alive) { nextIdx = (nextIdx + 1) % pOrder.length; }
     return localState.players[pOrder[nextIdx]].id;
}
    </script>
</body>
</html>
