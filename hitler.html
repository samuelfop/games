<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - Web Version</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --liberal: #65aadd; 
            --fascist: #d64d4d;
            --bg: #333;
            --text: #eee;
        }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); text-align: center; margin: 0; padding: 20px; }
        
        .hidden { display: none; }
        .card { border: 2px solid #fff; padding: 10px; margin: 10px; display: inline-block; border-radius: 5px; }
        .btn { padding: 15px 30px; font-size: 1.2em; cursor: pointer; background: #555; color: white; border: none; margin: 5px; }
        .btn-ja { background: var(--liberal); }
        .btn-nein { background: var(--fascist); }
        
        .track-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .track { border: 2px solid #777; padding: 10px; margin-bottom: 20px;}
        .policy-slot { 
            width: 60px; height: 90px; border: 2px dashed #999; 
            display: inline-block; margin: 5px; vertical-align: top;
            line-height: 90px; font-weight: bold; color: #555;
        }
        .policy-slot.filled-lib { background: var(--liberal); border-style: solid; color: white; }
        .policy-slot.filled-fas { background: var(--fascist); border-style: solid; color: white; }
        
        .secret-role { padding: 20px; border: 5px solid; display: none; margin: 20px auto; max-width: 300px;}
        .role-liberal { border-color: var(--liberal); }
        .role-fascist { border-color: var(--fascist); }
        
        #notification-area { position: fixed; top: 0; left: 0; width: 100%; background: gold; color: black; padding: 10px; font-weight: bold; display: none; z-index: 100;}
    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="setup-screen">
        <h1>SECRET HITLER</h1>
        <input type="text" id="playerName" placeholder="Enter Name" style="padding:10px;">
        <br><br>
        <button class="btn" onclick="createGame()">Create Game (Host/TV)</button>
        <button class="btn" onclick="joinGame()">Join Game (Player)</button>
    </div>

    <div id="host-view" class="hidden">
        <h2>Game Code: <span id="display-game-code" style="color:gold"></span></h2>
        <div id="lobby-list">Waiting for players...</div>
        <button id="start-btn" class="btn hidden" onclick="startGame()">START GAME</button>
        
        <div id="game-board" class="hidden">
            <h3>LIBERAL ACTS (5 to Win)</h3>
            <div id="lib-track" class="track" style="border-color: var(--liberal)"></div>

            <h3>FASCIST ACTS (6 to Win)</h3>
            <div id="fas-track" class="track" style="border-color: var(--fascist)"></div>
            
            <div style="margin-top:20px;">
                <p>Election Tracker: <span id="tracker-count">0</span>/3</p>
                <p>Deck Remaining: <span id="deck-count">17</span></p>
                <h2 id="game-status" style="color: gold; margin-top: 20px;">Status: Waiting...</h2>
            </div>
        </div>
    </div>

    <div id="player-view" class="hidden">
        <h2 id="my-name-display"></h2>
        <button class="btn" onclick="toggleRole()">Show/Hide Secret Role</button>
        
        <div id="my-role-card" class="secret-role">
            <h1 id="role-text">ROLE</h1>
            <p id="teammates-info"></p>
        </div>

        <hr>
        <div id="player-action-area">
            <h3 id="player-instruction" style="min-height: 50px;">Waiting for host...</h3>
            <div id="controls"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcn5aaeBbPfWRNm_xremdSHFuI6S4_VCs",
            authDomain: "seceret-4c9b8.firebaseapp.com",
            databaseURL: "https://seceret-4c9b8-default-rtdb.firebaseio.com",
            projectId: "seceret-4c9b8",
            storageBucket: "seceret-4c9b8.firebasestorage.app",
            messagingSenderId: "627949762930",
            appId: "1:627949762930:web:3cc0b43c5166d73c5705eb"
        };

        // Initialize Firebase
        if (typeof firebase === 'undefined') {
            alert("Error: Firebase SDK not loaded. Check internet connection.");
        } else {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // --- GLOBAL VARS ---
        let gameId = null;
        let myId = null;
        let isHost = false;
        let localState = {};

        // --- POWER BOARDS ---
        const BOARDS = {
            5: [null, null, 'peek', 'kill', 'kill', null],
            6: [null, null, 'peek', 'kill', 'kill', null],
            7: [null, 'investigate', 'special_election', 'kill', 'kill', null],
            8: [null, 'investigate', 'special_election', 'kill', 'kill', null],
            9: ['investigate', 'investigate', 'special_election', 'kill', 'kill', null],
            10: ['investigate', 'investigate', 'special_election', 'kill', 'kill', null]
        };

        // --- SETUP FUNCTIONS ---
        function createGame() {
            isHost = true;
            gameId = Math.floor(Math.random() * 9000 + 1000).toString();
            
            db.ref(gameId).set({
                state: 'LOBBY', 
                libPolicies: 0,
                fasPolicies: 0,
                electionTracker: 0,
                players: {},
                deck: shuffleDeck(),
                discard: [],
                president: null,
                chancellor: null,
                lastChancellor: null,
                lastPresident: null,
                votes: {},
                legislativeHand: [],
                executiveAction: null,
                notification: "Welcome to Secret Hitler"
            });

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('display-game-code').innerText = gameId;

            db.ref(gameId).on('value', snap => {
                localState = snap.val();
                if (localState) renderHost();
            });
            
            // Start the Host Logic Loop
            setInterval(() => {
                if (!isHost || !localState || !localState.state) return;
                if (localState.state === 'VOTING') {
                    const livingPlayers = Object.values(localState.players).filter(p => p.alive);
                    const votes = localState.votes || {};
                    if (Object.keys(votes).length >= livingPlayers.length && livingPlayers.length > 0) {
                        processVote(votes);
                    }
                }
            }, 1000);
        }

        function joinGame() {
            const name = document.getElementById('playerName').value;
            if(!name) return alert("Enter name");
            gameId = prompt("Enter Game Code:");
            myId = 'player_' + Date.now();
            
            // Ensure players path exists to avoid null errors
            db.ref(gameId + '/players/' + myId).set({
                name: name,
                role: null,
                party: null,
                id: myId,
                alive: true
            });

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('player-view').classList.remove('hidden');
            document.getElementById('my-name-display').innerText = name;

            db.ref(gameId).on('value', snap => {
                localState = snap.val();
                if (localState) renderPlayer();
            });
        }

        function startGame() {
            if (!localState || !localState.players) return alert("Wait for players to join.");
            const playerKeys = Object.keys(localState.players);
            const count = playerKeys.length;
            if (count < 5 || count > 10) return alert("Need 5-10 players!");

            let roles = [];
            let numFascists = 1; 
            if(count >= 7) numFascists = 2;
            if(count >= 9) numFascists = 3;
            
            roles.push('HITLER');
            for(let i=0; i<numFascists; i++) roles.push('FASCIST');
            while(roles.length < count) roles.push('LIBERAL');
            roles = roles.sort(() => Math.random() - 0.5);

            const updates = {};
            updates['state'] = 'NOMINATION';
            updates['president'] = playerKeys[Math.floor(Math.random() * count)];
            updates['presidentOrder'] = playerKeys; 

            playerKeys.forEach((key, index) => {
                const role = roles[index];
                updates[`players/${key}/role`] = role;
                updates[`players/${key}/party`] = (role === 'LIBERAL') ? 'LIBERAL' : 'FASCIST';
            });

            db.ref(gameId).update(updates);
        }

        // --- GAME LOGIC (HOST) ---
        function processVote(votes) {
            let jas = Object.values(votes).filter(v => v === 'ja').length;
            let neins = Object.values(votes).filter(v => v === 'nein').length;

            if (jas > neins) { // PASSED
                if (localState.fasPolicies >= 3 && getRole(localState.chancellor) === 'HITLER') {
                    return endGame("FASCISTS WIN! Hitler was elected Chancellor.");
                }

                let deck = localState.deck || [];
                if (deck.length < 3) {
                    deck = shuffleDeck(); 
                }
                const hand = deck.slice(0, 3);
                
                db.ref(gameId).update({
                    state: 'LEGISLATIVE_PRES',
                    legislativeHand: hand,
                    deck: deck.slice(3),
                    votes: {},
                    electionTracker: 0
                });
            } else { // FAILED
                advanceTurn(true);
            }
        }

        function advanceTurn(voteFailed = false) {
            let updates = {};
            
            if (voteFailed) {
                updates.electionTracker = (localState.electionTracker || 0) + 1;
                if (updates.electionTracker >= 3) {
                    const topCard = localState.deck[0];
                    updates.deck = localState.deck.slice(1);
                    updates.electionTracker = 0;
                    updates.libPolicies = localState.libPolicies + (topCard === 'LIBERAL' ? 1 : 0);
                    updates.fasPolicies = localState.fasPolicies + (topCard === 'FASCIST' ? 1 : 0);
                    updates.lastChancellor = null; 
                    updates.lastPresident = null;
                    updates.notification = "CHAOS! Top Policy Enacted: " + topCard;
                } else {
                    updates.notification = "Vote Failed. Tracker advances.";
                }
            } else {
                updates.lastPresident = localState.president;
                updates.lastChancellor = localState.chancellor;
            }

            // Rotate President
            let nextPres;
            if (localState.specialElectionReturn) {
                nextPres = localState.specialElectionReturn;
                updates.specialElectionReturn = null;
            } else {
                const pOrder = localState.presidentOrder || Object.keys(localState.players);
                const currIdx = pOrder.indexOf(localState.president);
                let nextIdx = (currIdx + 1) % pOrder.length;
                // Skip dead players
                let safety = 0;
                while (!localState.players[pOrder[nextIdx]].alive && safety < 20) {
                    nextIdx = (nextIdx + 1) % pOrder.length;
                    safety++;
                }
                nextPres = pOrder[nextIdx];
            }

            updates.state = 'NOMINATION';
            updates.president = nextPres;
            updates.chancellor = null;
            updates.votes = {};
            updates.legislativeHand = [];
            
            db.ref(gameId).update(updates);
        }

        function enactPolicy(policy) {
            let updates = { legislativeHand: [] };
            let newLib = localState.libPolicies;
            let newFas = localState.fasPolicies;

            if (policy === 'LIBERAL') {
                newLib++;
                updates.libPolicies = newLib;
                if (newLib >= 5) return endGame("LIBERALS WIN (5 Policies)");
                db.ref(gameId).update(updates).then(() => advanceTurn());
            } else {
                newFas++;
                updates.fasPolicies = newFas;
                if (newFas >= 6) return endGame("FASCISTS WIN (6 Policies)");

                const playerCount = Object.keys(localState.players).length;
                const board = BOARDS[playerCount] || BOARDS[5];
                const power = board[newFas - 1]; 

                if (power) {
                    updates.state = 'EXECUTIVE_ACTION';
                    updates.executiveAction = power;
                    updates.notification = `PRESIDENTIAL POWER UNLOCKED: ${power.toUpperCase()}`;
                    db.ref(gameId).update(updates);
                } else {
                    db.ref(gameId).update(updates).then(() => advanceTurn());
                }
            }
        }

        // --- PLAYER ACTIONS ---
        function handleVote(vote) { db.ref(gameId + '/votes/' + myId).set(vote); }

        function nominate(targetId) {
            const playerCount = Object.values(localState.players).filter(p => p.alive).length;
            if (targetId === localState.lastChancellor) return alert("Term Limited (Chancellor).");
            if (playerCount > 5 && targetId === localState.lastPresident) return alert("Term Limited (President).");
            
            db.ref(gameId).update({ chancellor: targetId, state: 'VOTING' });
        }

        function legislationDiscard(index) {
            let hand = [...localState.legislativeHand];
            hand.splice(index, 1);
            
            if (localState.state === 'LEGISLATIVE_PRES') {
                db.ref(gameId).update({ state: 'LEGISLATIVE_CHAN', legislativeHand: hand });
            } else {
                enactPolicy(hand[0]);
            }
        }

        function proposeVeto() { db.ref(gameId).update({ state: 'VETO_CONSENT' }); }

        function answerVeto(agree) {
            if (agree) advanceTurn(true);
            else db.ref(gameId).update({ state: 'LEGISLATIVE_CHAN' }); 
        }

        function performExecutiveAction(targetId) {
            const action = localState.executiveAction;
            let updates = { state: 'NOMINATION', executiveAction: null }; 

            if (action === 'investigate') {
                const party = localState.players[targetId].party;
                alert(`INVESTIGATION RESULT: ${party}`); 
            } 
            else if (action === 'kill') {
                if (getRole(targetId) === 'HITLER') return endGame("LIBERALS WIN! Hitler Assassinated.");
                updates[`players/${targetId}/alive`] = false;
            } 
            else if (action === 'special_election') {
                updates.state = 'NOMINATION';
                updates.president = targetId;
                updates.chancellor = null;
                updates.specialElectionReturn = getNextPresidentIndex(); 
                db.ref(gameId).update(updates);
                return; 
            }

            db.ref(gameId).update(updates).then(() => {
                 if (action !== 'special_election') advanceTurn();
            });
        }

        function peekPolicy() {
            const top3 = localState.deck.slice(0, 3);
            alert(`Top 3 Policies: ${top3.join(', ')}`);
            db.ref(gameId).update({ state: 'NOMINATION', executiveAction: null }).then(() => advanceTurn());
        }

        // --- RENDERING ---
        function renderHost() {
            document.getElementById('start-btn').classList.toggle('hidden', localState.state !== 'LOBBY');
            document.getElementById('game-board').classList.toggle('hidden', localState.state === 'LOBBY');
            
            if (localState.players) {
                const pList = Object.values(localState.players).map(p => 
                    p.alive ? p.name : `<span style="text-decoration:line-through; color:red">${p.name}</span>`
                ).join(', ');
                document.getElementById('lobby-list').innerHTML = pList;
            }

            renderTrack('lib-track', 5, localState.libPolicies, 'filled-lib');
            renderTrack('fas-track', 6, localState.fasPolicies, 'filled-fas');
            
            document.getElementById('tracker-count').innerText = localState.electionTracker;
            document.getElementById('deck-count').innerText = localState.deck ? localState.deck.length : 0;
            
            let status = localState.notification || "Waiting...";
            if(localState.state === 'VETO_CONSENT') status = "Chancellor proposed Veto. President deciding...";
            if(localState.state === 'EXECUTIVE_ACTION') status = `President executing power: ${localState.executiveAction}`;
            
            document.getElementById('game-status').innerText = status;
        }

        function renderPlayer() {
            if (!localState.players || !localState.players[myId]) return;
            const me = localState.players[myId];
            const roleEl = document.getElementById('my-role-card');
            const roleText = document.getElementById('role-text');
            
            if(me.role) {
                roleText.innerText = me.role;
                roleEl.className = 'secret-role ' + (me.role === 'LIBERAL' ? 'role-liberal' : 'role-fascist');
                if(me.role === 'FASCIST') {
                    const fascists = Object.values(localState.players).filter(p => p.role === 'FASCIST' || p.role === 'HITLER');
                    document.getElementById('teammates-info').innerText = "Fascists: " + fascists.map(p => `${p.name} (${p.role})`).join(', ');
                } else {
                    document.getElementById('teammates-info').innerText = "Liberals don't know anyone.";
                }
            }

            const controls = document.getElementById('controls');
            const info = document.getElementById('player-instruction');
            controls.innerHTML = ''; 

            if (!me.alive) {
                info.innerText = "YOU ARE DEAD.";
                return;
            }

            if (localState.state === 'NOMINATION') {
                if (localState.president === myId) {
                    info.innerText = "Nominate a Chancellor";
                    Object.values(localState.players).forEach(p => {
                        if (p.id !== myId && p.alive) {
                            controls.innerHTML += `<button class="btn" onclick="nominate('${p.id}')">${p.name}</button>`;
                        }
                    });
                } else {
                    info.innerText = `Waiting for President ${getName(localState.president)}...`;
                }
            }
            else if (localState.state === 'VOTING') {
                if (!localState.votes || !localState.votes[myId]) {
                    info.innerText = "Vote for Government";
                    controls.innerHTML = `
                        <button class="btn btn-ja" onclick="handleVote('ja')">JA</button>
                        <button class="btn btn-nein" onclick="handleVote('nein')">NEIN</button>
                    `;
                } else {
                    info.innerText = "Waiting for others to vote...";
                }
            }
            else if (localState.state === 'LEGISLATIVE_PRES' && localState.president === myId) {
                info.innerText = "Discard 1 Policy";
                localState.legislativeHand.forEach((card, i) => {
                    controls.innerHTML += `<button class="btn ${card==='LIBERAL'?'btn-ja':'btn-nein'}" onclick="legislationDiscard(${i})">${card}</button>`;
                });
            }
            else if (localState.state === 'LEGISLATIVE_CHAN' && localState.chancellor === myId) {
                info.innerText = "Discard 1 to Enact the other";
                localState.legislativeHand.forEach((card, i) => {
                    controls.innerHTML += `<button class="btn ${card==='LIBERAL'?'btn-ja':'btn-nein'}" onclick="legislationDiscard(${i})">${card}</button>`;
                });
                if (localState.fasPolicies === 5) {
                     controls.innerHTML += `<br><button class="btn" style="background:orange" onclick="proposeVeto()">PROPOSE VETO</button>`;
                }
            }
            else if (localState.state === 'VETO_CONSENT' && localState.president === myId) {
                info.innerText = "Chancellor wants to Veto. Agree?";
                controls.innerHTML = `
                    <button class="btn btn-ja" onclick="answerVeto(true)">AGREE (Discard All)</button>
                    <button class="btn btn-nein" onclick="answerVeto(false)">REJECT (Must Enact)</button>
                `;
            }
            else if (localState.state === 'EXECUTIVE_ACTION' && localState.president === myId) {
                const act = localState.executiveAction;
                info.innerText = `Perform Action: ${act.toUpperCase()}`;
                
                if (act === 'peek') {
                    controls.innerHTML = `<button class="btn" onclick="peekPolicy()">Peek Top 3 Cards</button>`;
                } else {
                    Object.values(localState.players).forEach(p => {
                        if (p.id !== myId && p.alive) { 
                            controls.innerHTML += `<button class="btn" style="background:purple" onclick="performExecutiveAction('${p.id}')">${p.name}</button>`;
                        }
                    });
                }
            } else {
                info.innerText = "Watch the TV screen...";
            }
        }

        // --- UTILS ---
        function shuffleDeck() {
            let deck = Array(6).fill('LIBERAL').concat(Array(11).fill('FASCIST'));
            return deck.sort(() => Math.random() - 0.5);
        }
        function getRole(id) { return localState.players[id] ? localState.players[id].role : null; }
        function getName(id) { return localState.players[id] ? localState.players[id].name : 'Unknown'; }
        
        function renderTrack(id, max, curr, cls) {
            const div = document.getElementById(id);
            div.innerHTML = '';
            for(let i=0; i<max; i++) {
                let d = document.createElement('div');
                d.className = `policy-slot ${i<curr ? cls : ''}`;
                d.innerText = i+1;
                div.appendChild(d);
            }
        }
        function endGame(msg) {
            db.ref(gameId).update({ state: 'GAMEOVER', notification: msg });
            alert(msg);
        }
        function toggleRole() {
            const el = document.getElementById('my-role-card');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        function getNextPresidentIndex() {
             const pOrder = localState.presidentOrder;
             const currIdx = pOrder.indexOf(localState.president);
             let nextIdx = (currIdx + 1) % pOrder.length;
             while (!localState.players[pOrder[nextIdx]].alive) {
                nextIdx = (nextIdx + 1) % pOrder.length;
             }
             return localState.players[pOrder[nextIdx]].id;
        }
    </script>
</body>
</html>
